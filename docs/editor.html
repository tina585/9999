<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>照片編輯器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            background-image: url('POT/S__4005892.jpg');
            background-color: transparent;
            background-size: cover;
            background-position: center top;
            background-repeat: no-repeat;
            background-attachment: scroll;
            overflow-x: hidden;
        }

        /* 功能說明 Modal 不受 body transform 影響，保持正常方向 */
        .function-guide-modal-overlay {
            transform: none !important;
        }
        
        /* 功能說明背景層 - 獨立滿版顯示，不影響其他元件 */
        /* 排除 modal-root 不受 body transform 影響 */
        #modal-root {
            transform: none !important;
        }
        
        .function-guide-background-layer {
            position: fixed;
            top: -80px;
            left: 0;
            right: 0;
            bottom: -50px;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 2999;
            transform: none !important;
        }
        
        .function-guide-modal-content {
            transform: none !important;
            position: relative !important;
            z-index: 3001 !important;
            pointer-events: auto !important;
        }
        
        .function-guide-close-btn {
            pointer-events: auto !important;
            z-index: 3010 !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 16px 32px 16px;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }

        .editor-area {
            background: #FEAC3C;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 24px;
            margin-top: 50px;
            position: relative;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        /* 響應式設計：在不同屏幕尺寸下調整位置 */
        @media (min-width: 1400px) {
            .editor-area {
                margin-right: 200px;
            }
        }
        
        @media (max-width: 1399px) {
            .editor-area {
                margin-right: auto;
            }
        }

        /* 編輯功能說明縮圖（在畫布旁） */
        .edit-guide-thumb {
            position: absolute;
            top: 55%;
            left: -240px;
            width: 240px;
            height: auto;
            display: block;
            pointer-events: none;
            transform: translateY(-50%);
        }

        .canvas-container {
            position: relative;
            width: 100%;
            margin: 0 auto;
            aspect-ratio: 4/3;
            border: 3px solid #FEAC3C;
            border-radius: 0;
            overflow: visible;
            box-shadow: none;
            background: transparent;
            box-sizing: border-box;
            margin-bottom: 12px;
            transform: none !important;
        }
        
        /* 編輯頁面左上角HOME按鈕 */
        .editor-home-btn {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(calc(-600px - 200px));
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex !important;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s ease;
            z-index: 2000;
            box-shadow: none;
        }
        
        /* 響應式設計：在不同屏幕尺寸下調整HOME按鈕位置 */
        @media (min-width: 1400px) {
            .editor-home-btn {
                left: 200px;
                transform: none;
            }
        }
        
        @media (max-width: 1399px) {
            .editor-home-btn {
                left: 20px;
                transform: none;
            }
        }
        
        .editor-home-btn img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            display: block;
        }
        
        .editor-home-btn:hover {
            background: transparent;
            color: white;
            transform: scale(1.05);
            box-shadow: none;
        }
        
        .editor-home-btn:active {
            transform: scale(0.95);
        }
        
        /* 編輯頁面右下角確認按鈕 */
        .editor-confirm-btn {
            position: fixed;
            bottom: 80px;
            right: 50%;
            transform: translateX(calc(600px / 2 + 250px));
            width: 50px;
            height: 42px;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex !important;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s ease;
            z-index: 900; /* 放在相機模態框之下 */
            box-shadow: none;
        }
        
        /* 響應式設計：在不同屏幕尺寸下調整確認按鈕位置 */
        @media (min-width: 1400px) {
            .editor-confirm-btn {
                right: 280px;
                transform: none;
            }
        }
        
        @media (max-width: 1399px) {
            .editor-confirm-btn {
                right: 30px;
                transform: none;
            }
        }
        
        .editor-confirm-btn img {
            width: 140px;
            height: 140px;
            object-fit: contain;
        }

        .editor-confirm-btn:hover:not(:disabled) {
            transform: scale(1.1);
        }
        
        .editor-confirm-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .editor-confirm-btn:disabled {
            cursor: not-allowed;
            opacity: 0.4;
        }

        .editor-confirm-btn:disabled img {
            opacity: 0.4;
        }

        #editorCanvas {
            width: 100%;
            height: 100%;
            display: block;
            transform: none !important;
        }

        .toolbar {
            background: white;
            border-radius: 0 0 24px 24px;
            padding: 16px 0 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
            margin-top: 0;
            width: 100%;
            margin: 0;
            box-sizing: border-box;
            border-left: 3px solid #FEAC3C;
            border-right: 3px solid #FEAC3C;
            border-bottom: 3px solid #FEAC3C;
        }

        .tool-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: transparent;
            position: relative;
            box-shadow: none;
            padding: 0;
            overflow: hidden;
        }

        .tool-btn:hover:not(.disabled) {
            transform: scale(1.05);
            background: transparent;
            box-shadow: none;
        }

        .tool-btn.active {
            transform: scale(1.1);
            background: transparent;
            box-shadow: none;
        }

        .tool-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #d3d3d3;
        }

        .tool-btn.disabled:hover {
            transform: none;
            background: #d3d3d3;
        }

        .tool-btn.recording {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }

        .tool-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* 歡迎提示模態框 */
        .welcome-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        .welcome-modal.active {
            display: flex;
        }

        .welcome-modal-content {
            background: white;
            border-radius: 24px;
            padding: 50px 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            box-sizing: border-box;
        }

        .welcome-message {
            margin-bottom: 30px;
            padding: 20px;
            box-sizing: border-box;
        }

        .welcome-message .ruby-line {
            font-size: 14px;
            color: #333;
            line-height: 2.2;
            margin: 0;
            padding: 15px 10px;
            display: block;
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            box-sizing: border-box;
            text-align: center;
            max-width: 480px;
            margin: 0 auto;
        }

        .welcome-message .ruby-line ruby {
            margin: 0 3px;
        }

        .welcome-message .ruby-line rt {
            font-size: 14px;
            padding-right: 8px;
        }

        .welcome-confirm-btn {
            background: #FEAC3C;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 40px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(254, 172, 60, 0.4);
            display: block;
            margin: 0 auto;
        }

        .welcome-confirm-btn:hover {
            background: #f5a623;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(254, 172, 60, 0.5);
        }

        .welcome-confirm-btn:active {
            transform: scale(0.95);
        }

        /* 錄音畫面框 */
        .recording-modal {
            display: none;
            position: fixed;
            top: -80px;
            left: 0;
            right: 0;
            bottom: -50px;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .recording-modal.active {
            display: flex;
        }

        .recording-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .recording-icon {
            position: relative;
            display: inline-block;
            margin-bottom: 24px;
        }

        .recording-pulse {
            position: absolute;
            inset: -20px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.3);
            animation: recordingPulse 1.5s ease-in-out infinite;
        }

        @keyframes recordingPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.3;
            }
        }

        /* 錄音完成確認框 */
        .recording-confirm-modal {
            display: none;
            position: fixed;
            top: -80px;
            left: 0;
            right: 0;
            bottom: -50px;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            align-items: center;
            justify-content: center;
        }

        .recording-confirm-modal.active {
            display: flex;
        }

        .recording-confirm-content {
            background: white;
            border-radius: 20px;
            padding: 24px 40px 32px 40px;
            max-width: 600px;
            width: auto;
            min-width: 480px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        .recording-confirm-content h3 {
            margin: 0 0 16px 0;
            padding-top: 16px;
            font-size: 20px;
            color: #333;
        }

        .recording-confirm-content p {
            margin-bottom: 24px;
            color: #555;
            line-height: 1.6;
        }

        .recording-confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: nowrap;
            align-items: center;
        }
        
        .recording-confirm-actions .btn {
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* 覆蓋 .btn 和 .btn-secondary 的樣式，確保重新錄音按鈕大小正確 */
        .recording-confirm-actions .recording-redo-btn.btn,
        .recording-confirm-actions .recording-redo-btn.btn-secondary,
        .recording-confirm-actions .btn.recording-redo-btn,
        .recording-confirm-actions .btn-secondary.recording-redo-btn {
            width: 150px !important;
            height: 106px !important;
            padding: 0 !important;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            min-width: 150px !important;
            min-height: 106px !important;
            max-width: 150px !important;
            max-height: 106px !important;
        }

        .recording-confirm-actions .btn-primary {
            background: #FEAC3C;
        }

        /* 錄音停止按鈕自訂圖片樣式 */
        .recording-actions .recording-stop-btn,
        .recording-stop-btn {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            box-shadow: none !important;
            width: 140px !important;
            height: auto !important;
            min-width: 140px !important;
        }

        .recording-actions .recording-stop-img,
        .recording-stop-img {
            width: 100% !important;
            height: auto !important;
            display: block !important;
            max-width: 100% !important;
        }


        /* 錄音圖示圖片樣式 */
        .recording-icon .recording-mic-img,
        .recording-mic-img {
            width: 100px !important;
            height: auto !important;
            display: block !important;
        }

        /* 重新錄音按鈕自訂圖片樣式 */
        .recording-confirm-actions .recording-redo-btn,
        .recording-redo-btn {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            box-shadow: none !important;
            width: 150px !important;
            height: 106px !important;
        }

        .recording-confirm-actions .recording-redo-img,
        .recording-redo-img {
            width: 100% !important;
            height: 100% !important;
            display: block !important;
            object-fit: contain !important;
        }

        /* 確認按鈕自訂圖片樣式 */
        .recording-confirm-actions .recording-confirm-btn,
        .recording-confirm-btn {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            box-shadow: none !important;
            width: 150px !important;
            height: 106px !important;
        }

        .recording-confirm-actions .recording-confirm-img,
        .recording-confirm-img {
            width: 100% !important;
            height: 100% !important;
            display: block !important;
            object-fit: contain !important;
        }

        .recording-time-display {
            font-size: 48px;
            font-weight: bold;
            color: #ef4444;
            margin-bottom: 24px;
            font-family: 'Courier New', monospace;
        }

        .recording-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        /* 模板選擇框 */
        .template-selection-modal {
            display: none;
            position: fixed;
            top: -80px;
            left: 0;
            right: 0;
            bottom: -50px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3001;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .template-selection-modal.active {
            display: flex;
        }

        .template-selection-content {
            background: #fff6e8;
            border-radius: 20px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .template-selection-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            border-radius: 50%;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .template-selection-close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .template-selection-content h3 {
            margin: 0 0 20px 0;
            font-size: 24px;
            color: #8b572a;
            text-align: center;
            font-weight: 700;
        }

        .template-selection-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 60px;
        }

        .template-selection-item {
            aspect-ratio: 1;
            border: 2px solid #eadfce;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }

        .template-selection-item:hover {
            transform: scale(1.05);
            border-color: #FEAC3C;
            box-shadow: 0 4px 12px rgba(254, 172, 60, 0.3);
        }

        .template-selection-item.selected {
            border-color: #FEAC3C;
            background: #fff6e8;
            box-shadow: 0 0 0 3px rgba(254, 172, 60, 0.3);
        }

        .template-selection-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .template-selection-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 12px;
        }

        .template-confirm-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #FEAC3C;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(254, 172, 60, 0.4);
        }

        .template-confirm-btn:hover:not(:disabled) {
            background: #f5a623;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(254, 172, 60, 0.5);
        }

        .template-confirm-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* 貼圖選擇框 */
        .sticker-selection-modal {
            display: none;
            position: fixed;
            top: -80px;
            left: 0;
            right: 0;
            bottom: -50px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3001;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .sticker-selection-modal.active {
            display: flex;
        }

        .sticker-selection-content {
            background: #fff6e8;
            border-radius: 20px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .sticker-selection-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            border-radius: 50%;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .sticker-selection-close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .sticker-selection-content h3 {
            margin: 0 0 20px 0;
            font-size: 24px;
            color: #8b572a;
            text-align: center;
            font-weight: 700;
        }

        .sticker-selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .sticker-selection-item {
            aspect-ratio: 1;
            border: 2px solid #eadfce;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }

        .sticker-selection-item:hover {
            transform: scale(1.05);
            border-color: #FEAC3C;
            box-shadow: 0 4px 12px rgba(254, 172, 60, 0.3);
        }

        .sticker-selection-item.selected {
            border-color: #FEAC3C;
            background: #fff6e8;
            box-shadow: 0 0 0 3px rgba(254, 172, 60, 0.3);
        }

        .sticker-selection-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .sticker-selection-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 12px;
        }

        .sticker-confirm-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #FEAC3C;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(254, 172, 60, 0.4);
        }

        .sticker-confirm-btn:hover:not(:disabled) {
            background: #f5a623;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(254, 172, 60, 0.5);
        }

        .sticker-confirm-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        /* 畫筆模態框 */
        .signature-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .signature-modal.active {
            display: flex;
        }

        .signature-content {
            background: white;
            border-radius: 24px;
            padding: 24px;
            max-width: 700px;
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .signature-header {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #8b572a;
        }

        #signatureCanvas {
            width: 100%;
            height: 300px;
            border: 2px solid #FEAC3C;
            border-radius: 12px;
            background: white;
            cursor: crosshair;
            touch-action: none;
            display: block;
        }

        .signature-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 24px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #64B5F6;
            color: white;
        }

        .btn-primary:hover {
            background: #42A5F5;
        }

        .btn-secondary {
            background: #d1d5db;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #9ca3af;
        }

        /* 編輯選單 */
        .edit-menu {
            display: none;
            position: fixed;
            top: 120px;
            right: 16px;
            left: auto;
            transform: none;
            background: #fff6e8;
            border: 1px solid #eadfce;
            border-radius: 16px;
            padding: 16px 18px;
            flex-direction: column;
            gap: 14px;
            z-index: 200;
            min-width: 260px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
            align-items: center;
        }

        .edit-menu.active {
            display: flex;
        }

        .edit-menu-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: #8b572a;
            font-weight: 700;
            text-align: center;
            font-size: 18px;
            letter-spacing: 2px;
        }

        .edit-actions {
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center;
            gap: 40px;
            width: 100%;
        }

        .edit-btn {
            flex: 0 0 auto;
            width: auto;
            height: 72px;
            padding: 0;
            border-radius: 0;
            border: none;
            background: transparent;
            color: #2d2d2d;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            box-shadow: none;
            overflow: visible;
            position: relative;
        }

        /* 注音樣式，與主頁一致 */
        .ruby-line {
            display: block;
            font-size: 14px;
            letter-spacing: 4px;
            white-space: nowrap;
        }

        .ruby-line ruby {
            ruby-position: inter-character;
            ruby-align: center;
            margin: 0 2px;
            display: inline-flex;
            align-items: center;
        }

        .ruby-line rt {
            display: inline-block;
            writing-mode: vertical-rl;
            font-size: 14px;
            line-height: 1;
            margin-left: 2px;
            position: relative;
            padding-right: 6px;
        }

        .ruby-line .tone {
            writing-mode: horizontal-tb;
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ruby-line .tone-dot {
            writing-mode: horizontal-tb;
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            line-height: 1;
        }

        .edit-btn:hover {
            box-shadow: none;
            transform: translateY(-1px);
            background: transparent;
        }

        .edit-btn:active {
            transform: translateY(0);
            box-shadow: none;
            background: transparent;
        }

        .edit-btn .edit-btn-label {
            font-size: 16px;
            color: #8b572a;
            line-height: 1;
        }

        .edit-btn img {
            width: 500%;
            height: 500%;
            object-fit: contain;
            border-radius: 0;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .edit-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .edit-btn {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #1976D2;
            transition: background 0.2s;
        }

        .edit-btn:hover {
            background: transparent;
        }

        /* 畫筆選單 */
        .brush-menu {
            display: none;
            position: absolute;
            top: 0;
            right: -270px;
            background: #fff6e8;
            border: 1px solid #eadfce;
            border-radius: 16px;
            padding: 10px;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
            width: 250px;
            max-height: none;
            overflow: visible;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        }

        .brush-menu.active {
            display: flex;
        }

        .brush-menu label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: #000000;
        }

        /* 顏色選擇器 */
        .brush-color-selector {
            width: 100%;
        }

        .brush-color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 3px;
            padding: 4px;
            background: #FFD4A3;
            border: 1px solid #333;
            border-radius: 8px;
        }

        .brush-color-option {
            width: 100%;
            aspect-ratio: 1;
            border: 1.5px solid #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .brush-color-option:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .brush-color-option.selected {
            border: 2px solid #000;
            box-shadow: 0 0 0 1.5px #FFD4A3;
        }

        .brush-color-option.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 2px #fff, 0 0 2px #fff;
        }

        .brush-menu select {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        /* 自定義粗細選擇器 */
        .brush-width-selector {
            position: relative;
            width: 100%;
        }

        .brush-width-display {
            width: 100%;
            padding: 8px 10px;
            background: #FFD4A3;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 32px;
        }

        .brush-width-display::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: var(--line-width, 50%);
            height: 2px;
            background: #333;
            pointer-events: none;
        }

        .brush-width-display::after {
            content: '▼';
            position: absolute;
            right: 12px;
            font-size: 10px;
            pointer-events: none;
        }

        .brush-width-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #FFD4A3;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }

        .brush-width-options.active {
            display: block;
        }

        .brush-width-option {
            padding: 8px 10px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 32px;
        }

        .brush-width-option::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            height: 2px;
            background: #333;
            pointer-events: none;
        }

        .brush-width-option[data-value="3"]::before { width: 30%; }
        .brush-width-option[data-value="5"]::before { width: 50%; }
        .brush-width-option[data-value="10"]::before { width: 70%; }

        .brush-width-option:last-child {
            border-bottom: none;
        }

        .brush-width-option:hover {
            background: #f5f5f5;
        }

        .brush-width-option.selected {
            background: #FFD4A3;
        }

        .brush-tools {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .brush-label-img {
            display: block;
            max-width: 70px;
            height: auto;
            margin-bottom: 4px;
        }

        .brush-tool-btn {
            flex: 1 1 0;
            width: 100%;
            height: 60px;
            padding: 0;
            border-radius: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            flex-direction: column;
            gap: 0;
            overflow: visible;
        }

        .brush-tool-btn:hover {
            background: transparent;
            transform: scale(1.02);
        }

        .brush-tool-btn.active {
            background: transparent;
        }

        .brush-tool-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
        }

        /* 音訊播放器 */
        .audio-player {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(calc(-600px / 2 - 24px));
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px;
            min-width: 280px;
            z-index: 1000;
            box-sizing: border-box;
        }
        
        /* 響應式設計：在不同屏幕尺寸下調整音訊播放器位置 */
        @media (min-width: 1400px) {
            .audio-player {
                left: 50%;
                transform: translateX(calc(-600px / 2 - 24px));
            }
        }
        
        @media (max-width: 1399px) {
            .audio-player {
                left: 20px;
                transform: none;
            }
        }
        
        @media (max-width: 768px) {
            .audio-player {
                left: 10px;
                right: 10px;
                min-width: auto;
                width: calc(100% - 20px);
            }
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .play-pause-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            transition: opacity 0.3s;
        }

        .play-pause-btn.playing {
            background: #ef4444;
            color: white;
        }

        .play-pause-btn:not(.playing) {
            background: #64B5F6;
            color: white;
        }

        .play-pause-btn:hover {
            opacity: 0.8;
        }

        .progress-container {
            flex: 1;
            min-width: 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 4px;
        }

        .progress-fill {
            height: 100%;
            background: #64B5F6;
            border-radius: 4px;
            transition: width 0.1s;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
        }

        .recording-time {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            color: #ef4444;
            font-weight: bold;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左上角HOME按鈕 -->
        <button class="editor-home-btn" id="editorHomeBtn" aria-label="回到主頁">
            <img src="POT/HOME.png" alt="HOME">
        </button>
        
        <!-- 右下角確認按鈕 -->
        <button class="editor-confirm-btn" id="editorConfirmBtn" aria-label="確認">
            <img src="POT/完成.png" alt="確認">
        </button>
        
        <!-- 編輯區域 -->
        <div class="editor-area">
            <img class="edit-guide-thumb" src="POT/編輯照片功能照.png" alt="功能說明">
            <div class="canvas-container">
                <canvas id="editorCanvas"></canvas>
                
                <!-- 照片編輯選單 -->
                <div class="edit-menu" id="editMenu">
                    <div class="edit-menu-header">
                        <img src="POT/照片調整.png" alt="照片調整" style="max-width: 180px; height: auto; display: block; margin: 0 auto;">
                    </div>
                </div>
                
                <!-- 畫筆選單 -->
                <div class="brush-menu" id="brushMenu">
                    <div>
                        <img src="POT/顏色.png" alt="顏色" class="brush-label-img">
                        <div class="brush-color-selector">
                            <div class="brush-color-grid" id="brushColorGrid">
                                <div class="brush-color-option" data-color="#000000" style="background-color: #000000;" title="黑色"></div>
                                <div class="brush-color-option" data-color="#FFFFFF" style="background-color: #FFFFFF;" title="白色"></div>
                                <div class="brush-color-option" data-color="#FF0000" style="background-color: #FF0000;" title="紅色"></div>
                                <div class="brush-color-option" data-color="#00FF00" style="background-color: #00FF00;" title="綠色"></div>
                                <div class="brush-color-option" data-color="#0000FF" style="background-color: #0000FF;" title="藍色"></div>
                                <div class="brush-color-option" data-color="#FFFF00" style="background-color: #FFFF00;" title="黃色"></div>
                                <div class="brush-color-option" data-color="#FF00FF" style="background-color: #FF00FF;" title="洋紅色"></div>
                                <div class="brush-color-option" data-color="#00FFFF" style="background-color: #00FFFF;" title="青色"></div>
                                <div class="brush-color-option" data-color="#FFA500" style="background-color: #FFA500;" title="橙色"></div>
                                <div class="brush-color-option" data-color="#800080" style="background-color: #800080;" title="紫色"></div>
                                <div class="brush-color-option" data-color="#FFC0CB" style="background-color: #FFC0CB;" title="粉紅色"></div>
                                <div class="brush-color-option" data-color="#A52A2A" style="background-color: #A52A2A;" title="棕色"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <img src="POT/粗細.png" alt="粗細" class="brush-label-img">
                        <div class="brush-width-selector">
                            <div class="brush-width-display" id="brushWidthDisplay"></div>
                            <div class="brush-width-options" id="brushWidthOptions">
                                <div class="brush-width-option" data-value="3"></div>
                                <div class="brush-width-option selected" data-value="5"></div>
                                <div class="brush-width-option" data-value="10"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="brush-tools">
                        <button class="brush-tool-btn" id="eraserToolBtn" title="橡皮擦">
                            <img src="POT/橡皮擦.png" alt="橡皮擦">
                        </button>
                        <button class="brush-tool-btn" id="undoBtn" title="復原">
                            <img src="POT/返回.png" alt="復原">
                        </button>
                    </div>
                </div>
                
                <!-- 音訊播放器 -->
                <div id="audioPlayer" class="audio-player" style="display: none;">
                    <audio id="audioElement"></audio>
                    <div class="audio-controls">
                        <button class="play-pause-btn" id="playPauseBtn">▶</button>
                        <div class="progress-container">
                            <div class="progress-bar" id="progressBar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="time-display">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 工具列 -->
            <div class="toolbar">
            <!-- 麥克風按鈕 -->
            <div class="tool-btn-container">
                <button class="tool-btn" id="microphoneBtn" title="錄音">
                        <img src="POT/錄音.png" alt="錄音">
                    <span class="recording-time" id="recordingTime" style="display: none;"></span>
                </button>
            </div>

            <!-- 照片編輯按鈕 -->
            <div class="tool-btn-container">
                <button class="tool-btn" id="imageEditBtn" title="照片編輯">
                        <img src="POT/照片調整ICON.png" alt="照片編輯">
                </button>
            </div>

            <!-- 畫筆按鈕 -->
            <div class="tool-btn-container">
                <button class="tool-btn" id="brushBtn" title="畫筆">
                        <img src="POT/繪畫.png" alt="畫筆">
                </button>
            </div>
        </div>
    </div>

    <!-- 畫筆模態框 -->
    <div class="signature-modal" id="signatureModal">
        <div class="signature-content">
            <div class="signature-header">
                <span class="ruby-line">
                    <ruby>畫<rt>ㄏㄨㄚ<span class="tone">ˋ</span></rt></ruby>
                    <ruby>筆<rt>ㄅㄧ<span class="tone">ˇ</span></rt></ruby>
                </span>
            </div>
            <canvas id="signatureCanvas" width="600" height="300"></canvas>
            <div class="signature-actions">
                <button class="btn btn-secondary" id="clearSignatureBtn">
                    <span class="ruby-line">
                        <ruby>清<rt>ㄑㄧㄥ</rt></ruby>
                        <ruby>除<rt>ㄔㄨ<span class="tone">ˊ</span></rt></ruby>
                    </span>
                </button>
                <button class="btn btn-secondary" id="cancelSignatureBtn">
                    <span class="ruby-line">
                        <ruby>取<rt>ㄑㄩ<span class="tone">ˇ</span></rt></ruby>
                        <ruby>消<rt>ㄒㄧㄠ</rt></ruby>
                    </span>
                </button>
                <button class="btn btn-primary" id="confirmSignatureBtn">
                    <span class="ruby-line">
                        <ruby>確<rt>ㄑㄩㄝ<span class="tone">ˋ</span></rt></ruby>
                        <ruby>認<rt>ㄖㄣ<span class="tone">ˋ</span></rt></ruby>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- 錄音畫面框 -->
    <div class="recording-modal" id="recordingModal">
        <div class="recording-content">
            <div class="recording-icon">
                <div class="recording-pulse"></div>
                <img src="POT/錄音.png" alt="錄音" class="recording-mic-img">
            </div>
            <div class="recording-time-display" id="recordingTimeDisplay">0:00</div>
            <div class="recording-actions">
                <button class="btn btn-primary recording-stop-btn" id="stopRecordingBtn" aria-label="停止錄音">
                    <img src="POT/停止錄音.png" alt="停止錄音" class="recording-stop-img">
                </button>
            </div>
        </div>
    </div>

    <!-- React Modal 組件 -->
    <div id="modal-root"></div>

    <!-- 錄音完成確認框 -->
    <div class="recording-confirm-modal" id="recordingConfirmModal">
        <div class="recording-confirm-content">
            <img src="POT/錄音完成.png" alt="錄音完成" style="max-width: 260px; width: 100%; height: auto; display: block; margin: 0 auto 12px;">
            <audio id="recordingPreview" controls style="width: 100%; margin-bottom: 16px;"></audio>
            <div class="recording-confirm-actions">
                <button class="btn btn-secondary recording-redo-btn" id="redoRecordingBtn" aria-label="重新錄音">
                    <img src="POT/重新錄音.png" alt="重新錄音" class="recording-redo-img">
                </button>
                <button class="btn btn-primary recording-confirm-btn" id="confirmRecordingBtn" aria-label="確認">
                    <img src="POT/確認錄音.png" alt="確認" class="recording-confirm-img">
                </button>
            </div>
        </div>
    </div>

    <!-- 模板選擇框 -->
    <div class="template-selection-modal" id="templateSelectionModal">
        <div class="template-selection-content">
            <button class="template-selection-close-btn" id="closeTemplateSelectionBtn" aria-label="關閉">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h3>選擇裝飾模板</h3>
            <div class="template-selection-grid" id="templateSelectionGrid">
                <!-- 模板項目將由 JavaScript 動態生成 -->
            </div>
            <div class="template-selection-actions">
                <button class="template-confirm-btn" id="confirmTemplateBtn" aria-label="確認" disabled>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 貼圖選擇框 -->
    <div class="sticker-selection-modal" id="stickerSelectionModal">
        <div class="sticker-selection-content">
            <button class="sticker-selection-close-btn" id="closeStickerSelectionBtn" aria-label="關閉">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h3>選擇貼圖</h3>
            <div class="sticker-selection-grid" id="stickerSelectionGrid">
                <!-- 貼圖項目將由 JavaScript 動態生成 -->
            </div>
            <div class="sticker-selection-actions">
                <button type="button" class="sticker-confirm-btn" id="confirmStickerBtn" aria-label="確認" disabled>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

   




    <script>
        // 初始化 Fabric.js Canvas
        let canvas = null;
        let currentImage = null;
        let mainPhotoObj = null; // 目前畫布上的主照片，可縮放移動
        let audioBlob = null;
        let audioUrl = null;
        let isDrawing = false;
        let brushColor = '#000000';
        let brushWidth = 5;
        let currentTool = 'pen'; // 'pen' or 'eraser'
        let historyState = [];
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingTime = 0;
        let shouldShowStickerModal = false;
        let shouldShowTemplateModal = false; // 是否需要顯示模板選擇視窗
        let selectedStickerId = null; // 當前選中的貼圖ID
        let hasPhotoAdjusted = false; // 照片是否被調整過
        let hasDrawing = false; // 是否有繪畫內容
        let photoOriginalProps = null; // 照片原始屬性（位置、縮放、角度等）

        // 貼圖數據
        const STICKERS = [
            { id: 'sticker1', name: '粉紅色心形眼鏡', image: 'POT/sticker1.png' },
            { id: 'sticker2', name: '黑色貓眼眼鏡', image: 'POT/sticker2.png' },
            { id: 'sticker3', name: '銀色太陽眼鏡', image: 'POT/sticker3.png' },
            { id: 'sticker4', name: '橙色太陽眼鏡', image: 'POT/sticker4.png' },
            { id: 'sticker5', name: '大眼睛', image: 'POT/sticker5.png' },
            { id: 'sticker6', name: '紅色心形眼鏡', image: 'POT/sticker6.png' }
        ];

        // 模板數據（目前未使用，保留空數組以備將來使用）
        const TEMPLATES = [];

       
        let selectedTemplateId = null; // 當前選中的模板ID

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            const canvasEl = document.getElementById('editorCanvas');
            canvas = new fabric.Canvas('editorCanvas', {
                width: canvasEl.offsetWidth,
                height: canvasEl.offsetHeight,
                backgroundColor: '#ffffff'
            });

            // 畫筆模式預設關閉，改用畫筆模態
            canvas.isDrawingMode = false;
            canvas.freeDrawingBrush.width = brushWidth;
            canvas.freeDrawingBrush.color = brushColor;
            canvas.freeDrawingBrush.strokeLineCap = 'round';
            canvas.freeDrawingBrush.strokeLineJoin = 'round';

            // 錄音功能
            document.getElementById('microphoneBtn').addEventListener('click', toggleRecording);
            document.getElementById('stopRecordingBtn').addEventListener('click', stopRecording);
            document.getElementById('confirmRecordingBtn').addEventListener('click', confirmRecording);
            document.getElementById('redoRecordingBtn').addEventListener('click', redoRecording);

            // 編輯頁面HOME按鈕
            const editorHomeBtn = document.getElementById('editorHomeBtn');
            if (editorHomeBtn) {
                editorHomeBtn.addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
            }
            
            // 編輯頁面確認按鈕
            const editorConfirmBtn = document.getElementById('editorConfirmBtn');
            if (editorConfirmBtn) {
                editorConfirmBtn.addEventListener('click', confirmEditorTemplate);
            }


            // 歡迎提示確認按鈕
            const welcomeConfirmBtn = document.getElementById('welcomeConfirmBtn');
            if (welcomeConfirmBtn) {
                welcomeConfirmBtn.addEventListener('click', closeWelcomeModal);
            }

            // 照片編輯功能
            document.getElementById('imageEditBtn').addEventListener('click', toggleEditMenu);

            // 畫筆模式功能（直接切換塗鴉）
            document.getElementById('brushBtn').addEventListener('click', toggleBrush);
            
            // 顏色選擇器功能
            const brushColorGrid = document.getElementById('brushColorGrid');
            if (brushColorGrid) {
                const brushColorOptions = brushColorGrid.querySelectorAll('.brush-color-option');
                
                // 設置預設選中黑色
                brushColorOptions.forEach(option => {
                    if (option.dataset.color === brushColor) {
                        option.classList.add('selected');
                    }
                });
                
                brushColorOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const selectedColor = option.dataset.color;
                        brushColor = selectedColor;
                        
                        // 更新選中狀態
                        brushColorOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        
                        // 更新畫筆顏色
                        if (canvas) {
                            if (currentTool === 'pen') {
                                canvas.freeDrawingBrush.color = brushColor;
                            }
                        }
                    });
                });
            }
            // 粗細選擇器功能
            const brushWidthDisplay = document.getElementById('brushWidthDisplay');
            const brushWidthOptions = document.getElementById('brushWidthOptions');
            
            if (brushWidthDisplay && brushWidthOptions) {
                const brushWidthOptionElements = brushWidthOptions.querySelectorAll('.brush-width-option');

                brushWidthDisplay.addEventListener('click', (e) => {
                    e.stopPropagation();
                    brushWidthOptions.classList.toggle('active');
                });

                // 更新顯示的粗細線條
                function updateBrushWidthDisplay() {
                    // 根據粗細值計算線條寬度百分比
                    const widthMap = {
                        3: 30, 5: 50, 10: 70
                    };
                    const lineWidth = widthMap[brushWidth] || 50;
                    brushWidthDisplay.style.setProperty('--line-width', lineWidth + '%');
                }
                updateBrushWidthDisplay();

                brushWidthOptionElements.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const value = parseInt(option.getAttribute('data-value'));
                        brushWidth = value;
                        
                        // 更新選中狀態
                        brushWidthOptionElements.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        
                        // 更新顯示
                        updateBrushWidthDisplay();
                        
                        // 關閉選單
                        brushWidthOptions.classList.remove('active');
                        
                        // 更新畫筆模式粗細
                        if (canvas && canvas.isDrawingMode && currentTool === 'pen') {
                            canvas.freeDrawingBrush.width = brushWidth;
                            canvas.freeDrawingBrush.strokeLineCap = 'round';
                            canvas.freeDrawingBrush.strokeLineJoin = 'round';
                        }
                    });
                });

                // 點擊外部關閉選單
                document.addEventListener('click', (e) => {
                    const selector = e.target.closest('.brush-width-selector');
                    if (!selector) {
                        brushWidthOptions.classList.remove('active');
                    }
                }, true);
            }

            // 畫筆工具切換（如有畫筆按鈕才綁定）
            const penToolBtn = document.getElementById('penToolBtn');
            if (penToolBtn) {
                penToolBtn.addEventListener('click', () => {
                    switchToPen();
                    toggleBrush();
                });
            }

            // 檢查 localStorage 是否可用
            function isLocalStorageAvailable() {
                try {
                    const test = '__localStorage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    console.warn('localStorage 不可用:', e);
                    return false;
                }
            }

            // 重置所有狀態變量（確保可以多次上傳）
            // 只有在不是從拍照頁面來的時候才重置（避免清除新載入的照片）
            const urlParams = new URLSearchParams(window.location.search);
            const fromCamera = urlParams.get('fromCamera') === '1';
            
            if (!fromCamera) {
                // 如果不是從拍照頁面來的，重置所有狀態
                audioBlob = null;
                hasPhotoAdjusted = false;
                hasDrawing = false;
                currentImage = null;
                mainPhotoObj = null;
                
                // 清空畫布
                if (canvas) {
                    canvas.clear();
                    canvas.renderAll();
                }
            }
            
            if (fromCamera) {
                // 檢查 localStorage 是否可用
                if (isLocalStorageAvailable()) {
                    // 從 localStorage 讀取照片和模板數據
                    try {
                        const cameraDataStr = localStorage.getItem('cameraData');
                        if (cameraDataStr) {
                            const cameraData = JSON.parse(cameraDataStr);
                            if (cameraData && cameraData.photo) {
                                // 確保畫布已完全初始化後再載入
                                setTimeout(() => {
                                    if (canvas && cameraData.photo) {
                                        // 設置標記，在照片載入完成後顯示貼圖選擇視窗
                                        shouldShowStickerModal = true;
                                        
                                        // 載入照片到畫布
                                        loadImageToCanvas(cameraData.photo);
                                        
                                        // 清除 localStorage 中的數據
                                        try {
                                            localStorage.removeItem('cameraData');
                                        } catch (e) {
                                            console.warn('清除 localStorage 失敗:', e);
                                        }
                                    }
                                }, 300);
                            }
                        }
                    } catch (e) {
                        console.error('讀取拍照數據失敗:', e);
                    }
                }
            }
            
            // 畫筆功能
            setupSignatureCanvas();
            document.getElementById('clearSignatureBtn').addEventListener('click', clearSignature);
            document.getElementById('cancelSignatureBtn').addEventListener('click', closeSignatureModal);
            document.getElementById('confirmSignatureBtn').addEventListener('click', confirmSignature);
            document.getElementById('eraserToolBtn').addEventListener('click', () => {
                switchToEraser();
            });
            document.getElementById('undoBtn').addEventListener('click', undoLastAction);

            // 監聽畫布變化，自動保存歷史
            canvas.on('path:created', (e) => {
                hasDrawing = true;
                saveHistory();
                updateConfirmButtonState();
            });

            // 當選中對象時，檢查是否允許選中照片
            canvas.on('object:selected', (e) => {
                const selectedObj = e.target;
                // 如果選中的是照片，檢查照片調整按鈕是否激活
                if (selectedObj && selectedObj.isBasePhoto) {
                    const imageEditBtn = document.getElementById('imageEditBtn');
                    const isEditModeActive = imageEditBtn && imageEditBtn.classList.contains('active');
                    
                    // 如果照片調整模式未激活，取消選中並鎖定照片
                    if (!isEditModeActive) {
                        selectedObj.set({
                            selectable: false,
                            evented: false,
                            hasControls: false,
                            hasBorders: false,
                            lockRotation: true,
                            lockScalingX: true,
                            lockScalingY: true,
                            lockMovementX: true,
                            lockMovementY: true
                        });
                        canvas.discardActiveObject();
                        canvas.renderAll();
                        return;
                    }
                }
                
                // 如果選中對象時正在繪畫模式，暫時禁用繪畫模式
                if (canvas.isDrawingMode) {
                    canvas.isDrawingMode = false;
                }
            });

            // 當對象開始移動時，檢查是否允許移動照片
            canvas.on('object:moving', (e) => {
                const movingObj = e.target;
                // 如果移動的是照片，檢查照片調整按鈕是否激活
                if (movingObj && movingObj.isBasePhoto) {
                    const imageEditBtn = document.getElementById('imageEditBtn');
                    const isEditModeActive = imageEditBtn && imageEditBtn.classList.contains('active');
                    
                    // 如果照片調整模式未激活，阻止移動
                    if (!isEditModeActive) {
                        e.e.cancel = true;
                        movingObj.set({
                            left: movingObj.left,
                            top: movingObj.top
                        });
                        canvas.renderAll();
                        return;
                    }
                }
                
                // 禁用繪畫模式
                if (canvas.isDrawingMode) {
                    canvas.isDrawingMode = false;
                }
            });

            // 當對象修改完成時（移動、縮放、旋轉），標記照片已調整
            canvas.on('object:modified', (e) => {
                const modifiedObj = e.target;
                if (modifiedObj && modifiedObj.isBasePhoto) {
                    hasPhotoAdjusted = true;
                    updateConfirmButtonState();
                }
            });
            
            // 當對象開始縮放時，檢查是否允許縮放照片
            canvas.on('object:scaling', (e) => {
                const scalingObj = e.target;
                if (scalingObj && scalingObj.isBasePhoto) {
                    const imageEditBtn = document.getElementById('imageEditBtn');
                    const isEditModeActive = imageEditBtn && imageEditBtn.classList.contains('active');
                    
                    // 如果照片調整模式未激活，阻止縮放
                    if (!isEditModeActive) {
                        e.e.cancel = true;
                        scalingObj.set({
                            scaleX: scalingObj.scaleX,
                            scaleY: scalingObj.scaleY
                        });
                        canvas.renderAll();
                    }
                }
            });
            
            // 當對象開始旋轉時，檢查是否允許旋轉照片
            canvas.on('object:rotating', (e) => {
                const rotatingObj = e.target;
                if (rotatingObj && rotatingObj.isBasePhoto) {
                    const imageEditBtn = document.getElementById('imageEditBtn');
                    const isEditModeActive = imageEditBtn && imageEditBtn.classList.contains('active');
                    
                    // 如果照片調整模式未激活，阻止旋轉
                    if (!isEditModeActive) {
                        e.e.cancel = true;
                        rotatingObj.set({
                            angle: rotatingObj.angle
                        });
                        canvas.renderAll();
                    }
                }
            });

            // 當對象被取消選中時，只有在畫筆按鈕是 active 狀態時才恢復繪畫模式
            canvas.on('selection:cleared', () => {
                // 只有當畫筆按鈕是 active 狀態時，才恢復繪畫模式
                const brushBtn = document.getElementById('brushBtn');
                if (brushBtn && brushBtn.classList.contains('active')) {
                    canvas.isDrawingMode = true;
                    isDrawing = true;
                } else {
                    // 如果畫筆按鈕不是 active，確保繪畫模式關閉
                    canvas.isDrawingMode = false;
                    isDrawing = false;
                }
            });

            // 初始化歷史狀態
            saveHistory();

            // 初始化畫筆工具按鈕狀態（不自動開啟繪畫模式）
            // 確保初始狀態：isDrawing = false, canvas.isDrawingMode = false
            isDrawing = false;
            canvas.isDrawingMode = false;
            const penToolBtnInit = document.getElementById('penToolBtn');
            if (penToolBtnInit) {
                penToolBtnInit.classList.add('active');
            }
            currentTool = 'pen';

            // 所有功能一開始就啟用，不需要先拍照

            // 確保確認按鈕始終顯示，初始狀態為禁用
            const confirmBtn = document.getElementById('editorConfirmBtn');
            if (confirmBtn) {
                confirmBtn.style.display = 'flex';
                confirmBtn.disabled = true;
            }
            // 初始檢查按鈕狀態
            updateConfirmButtonState();

            // 音訊播放器
            setupAudioPlayer();

            // 貼圖選擇框關閉按鈕
            const closeStickerSelectionBtn = document.getElementById('closeStickerSelectionBtn');
            if (closeStickerSelectionBtn) {
                closeStickerSelectionBtn.addEventListener('click', closeStickerSelectionModal);
            }

            // 貼圖選擇框確認按鈕
            const confirmStickerBtn = document.getElementById('confirmStickerBtn');
            if (confirmStickerBtn) {
                confirmStickerBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (selectedStickerId) {
                        // 立即關閉視窗
                        closeStickerSelectionModal();
                        // 然後應用貼圖
                        applySticker(selectedStickerId);
                    }
                });
            }

            // 模板選擇框關閉按鈕
            const closeTemplateSelectionBtn = document.getElementById('closeTemplateSelectionBtn');
            if (closeTemplateSelectionBtn) {
                closeTemplateSelectionBtn.addEventListener('click', closeTemplateSelectionModal);
            }

            // 模板選擇框確認按鈕
            const confirmTemplateBtn = document.getElementById('confirmTemplateBtn');
            if (confirmTemplateBtn) {
                confirmTemplateBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (selectedTemplateId) {
                        // 立即關閉視窗
                        closeTemplateSelectionModal();
                        // 然後應用模板
                        applyTemplate(selectedTemplateId);
                    }
                });
            }

        });


        // 關閉歡迎提示（若不存在則略過）
        function closeWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 顯示貼圖選擇框
        function showStickerSelectionModal() {
            const modal = document.getElementById('stickerSelectionModal');
            const grid = document.getElementById('stickerSelectionGrid');
            const confirmBtn = document.getElementById('confirmStickerBtn');

            if (!modal || !grid || !confirmBtn) {
                console.error('貼圖選擇框元素不存在');
                return;
            }

            // 重置選中狀態
            selectedStickerId = null;
            confirmBtn.disabled = true;

            grid.innerHTML = '';
            STICKERS.forEach((sticker) => {
                const item = document.createElement('div');
                item.className = 'sticker-selection-item';
                item.dataset.stickerId = sticker.id;
                item.innerHTML = `<img src="${sticker.image}" alt="${sticker.name}" onerror="console.error('貼圖圖片載入失敗:', '${sticker.image}'); this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding:20px;text-align:center;color:#999;\\'>${sticker.name}</div>'">`;

                item.addEventListener('click', () => {
                    // 移除所有選中狀態
                    document.querySelectorAll('.sticker-selection-item').forEach(el => {
                        el.classList.remove('selected');
                    });
                    // 選中當前項目
                    item.classList.add('selected');
                    selectedStickerId = sticker.id;
                    // 啟用確認按鈕
                    confirmBtn.disabled = false;
                });

                grid.appendChild(item);
            });

            modal.classList.add('active');
        }

        // 關閉貼圖選擇框
        function closeStickerSelectionModal() {
            const modal = document.getElementById('stickerSelectionModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 顯示模板選擇框
        function showTemplateSelectionModal() {
            const modal = document.getElementById('templateSelectionModal');
            const grid = document.getElementById('templateSelectionGrid');
            const confirmBtn = document.getElementById('confirmTemplateBtn');

            if (!modal || !grid || !confirmBtn) {
                console.error('模板選擇框元素不存在');
                return;
            }

            // 重置選中狀態
            selectedTemplateId = null;
            confirmBtn.disabled = true;

            grid.innerHTML = '';
            // 目前沒有模板，顯示提示訊息
            if (TEMPLATES.length === 0) {
                grid.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">暫無可用模板</div>';
                return;
            }
            TEMPLATES.forEach((template) => {
                const item = document.createElement('div');
                item.className = 'template-selection-item';
                item.dataset.templateId = template.id;
                item.innerHTML = `<img src="${template.image}" alt="${template.name}" onerror="console.error('模板圖片載入失敗:', '${template.image}'); this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding:20px;text-align:center;color:#999;\\'>${template.name}</div>'">`;

                item.addEventListener('click', () => {
                    // 移除所有選中狀態
                    document.querySelectorAll('.template-selection-item').forEach(el => {
                        el.classList.remove('selected');
                    });
                    // 選中當前項目
                    item.classList.add('selected');
                    selectedTemplateId = template.id;
                    // 啟用確認按鈕
                    confirmBtn.disabled = false;
                });

                grid.appendChild(item);
            });

            modal.classList.add('active');
        }

        // 關閉模板選擇框
        function closeTemplateSelectionModal() {
            const modal = document.getElementById('templateSelectionModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 應用模板到畫布
        function applyTemplate(templateId) {
            console.log('開始應用模板:', templateId);

            if (!canvas) {
                console.error('Canvas 未初始化');
                alert('畫布未初始化，無法應用模板');
                return;
            }

            const template = TEMPLATES.find(t => t.id === templateId);
            if (!template) {
                console.error('找不到模板:', templateId);
                alert('找不到模板: ' + templateId);
                return;
            }

            console.log('載入模板圖片:', template.image);

            // 先移除現有的模板（如果有的話）
            const existingTemplates = canvas.getObjects().filter(obj => obj.isTemplate);
            existingTemplates.forEach(obj => {
                canvas.remove(obj);
            });

            fabric.Image.fromURL(template.image, (templateImg) => {
                if (!templateImg) {
                    console.error('無法載入模板圖片:', template.image);
                    alert('無法載入模板圖片: ' + template.name + '\n\n請確認文件路徑: ' + template.image);
                    return;
                }

                console.log('模板圖片載入成功，尺寸:', templateImg.width, 'x', templateImg.height);

                // 將模板調整為畫布大小
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const scaleX = canvasWidth / templateImg.width;
                const scaleY = canvasHeight / templateImg.height;
                const scale = Math.max(scaleX, scaleY);

                templateImg.set({
                    left: 0,
                    top: 0,
                    originX: 'left',
                    originY: 'top',
                    scaleX: scale,
                    scaleY: scale,
                    selectable: false,
                    evented: false,
                    hasControls: false,
                    hasBorders: false,
                    lockRotation: true,
                    lockScalingX: true,
                    lockScalingY: true,
                    lockMovementX: true,
                    lockMovementY: true,
                    isTemplate: true,
                    globalCompositeOperation: 'source-over'
                });

                // 將模板放在最底層（背景）
                canvas.add(templateImg);
                canvas.sendToBack(templateImg);
                
                // 確保照片在模板上方
                if (mainPhotoObj) {
                    canvas.bringToFront(mainPhotoObj);
                }

                canvas.renderAll();
                saveHistory();
                
                console.log('模板已成功添加到畫布');

            }, (error) => {
                // 錯誤處理回調
                console.error('載入模板圖片時發生錯誤:', error);
                alert('載入模板圖片失敗: ' + template.name + '\n\n請確認文件路徑: ' + template.image);
            });
        }

        // 應用貼圖到畫布
        function applySticker(stickerId) {
            console.log('開始應用貼圖:', stickerId);
            
            if (!canvas) {
                console.error('無法套用貼圖: canvas 不存在');
                return;
            }

            // 檢查是否有照片在畫布上（不強制要求 currentImage，只要有照片物件即可）
            const hasPhoto = canvas.getObjects().some(obj => obj.isBasePhoto);
            if (!hasPhoto) {
                console.warn('畫布上沒有照片，但繼續添加貼圖');
            }

            const sticker = STICKERS.find(s => s.id === stickerId);
            if (!sticker) {
                console.error('找不到貼圖:', stickerId);
                alert('找不到貼圖: ' + stickerId);
                return;
            }

            console.log('載入貼圖圖片:', sticker.image);

            fabric.Image.fromURL(sticker.image, (stickerImg) => {
                if (!stickerImg) {
                    console.error('無法載入貼圖圖片:', sticker.image);
                    alert('無法載入貼圖圖片: ' + sticker.name + '\n\n請確認文件路徑: ' + sticker.image);
                    return;
                }

                console.log('貼圖圖片載入成功，尺寸:', stickerImg.width, 'x', stickerImg.height);

                // 計算貼圖大小（約為畫布的30-40%）
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const maxSize = Math.min(canvasWidth, canvasHeight) * 0.4;
                
                const scaleX = maxSize / stickerImg.width;
                const scaleY = maxSize / stickerImg.height;
                const scale = Math.min(scaleX, scaleY);

                // 將貼圖放在畫布中央（相對於照片位置）
                let stickerLeft = (canvasWidth - stickerImg.width * scale) / 2;
                let stickerTop = (canvasHeight - stickerImg.height * scale) / 2;
                
                // 如果有照片，確保貼圖在照片的可見區域內
                if (mainPhotoObj) {
                    const photoLeft = mainPhotoObj.left || 0;
                    const photoTop = mainPhotoObj.top || 0;
                    const photoWidth = (mainPhotoObj.width || canvasWidth) * (mainPhotoObj.scaleX || 1);
                    const photoHeight = (mainPhotoObj.height || canvasHeight) * (mainPhotoObj.scaleY || 1);
                    
                    // 將貼圖放在照片中央
                    stickerLeft = photoLeft + (photoWidth - stickerImg.width * scale) / 2;
                    stickerTop = photoTop + (photoHeight - stickerImg.height * scale) / 2;
                }

                stickerImg.set({
                    left: stickerLeft,
                    top: stickerTop,
                    originX: 'left',
                    originY: 'top',
                    scaleX: scale,
                    scaleY: scale,
                    selectable: true,
                    evented: true,
                    hasControls: true,
                    hasBorders: true,
                    lockRotation: false,
                    lockScalingX: false,
                    lockScalingY: false,
                    lockMovementX: false,
                    lockMovementY: false,
                    cornerSize: 12,
                    transparentCorners: false,
                    borderColor: '#FEAC3C',
                    cornerColor: '#FEAC3C',
                    stickerId: stickerId,
                    globalCompositeOperation: 'source-over'
                });

                console.log('添加貼圖到畫布，位置:', stickerLeft, stickerTop, '縮放:', scale);
                canvas.add(stickerImg);
                
                // 確保貼圖顯示在照片上方
                if (mainPhotoObj) {
                    canvas.bringToFront(stickerImg);
                    // 確保照片在貼圖下方
                    canvas.sendToBack(mainPhotoObj);
                }
                
                canvas.setActiveObject(stickerImg);
                canvas.renderAll();
                saveHistory();
                
                console.log('貼圖已成功添加到畫布');

            }, (error) => {
                // 錯誤處理回調
                console.error('載入貼圖圖片時發生錯誤:', error);
                alert('載入貼圖圖片失敗: ' + sticker.name + '\n\n請確認文件路徑: ' + sticker.image);
            });
        }

        // 載入圖片到 Canvas
        function loadImageToCanvas(imageUrl) {
            currentImage = imageUrl;
            
            // 先清除 mainPhotoObj 引用
            if (mainPhotoObj) {
                try {
                    canvas.remove(mainPhotoObj);
                } catch (e) {
                    // 移除 mainPhotoObj 時發生錯誤（靜默處理）
                }
                mainPhotoObj = null;
            }
            
            // 清除所有照片相關物件（包括 isBasePhoto 標記的照片）
            const objects = canvas.getObjects();
            const objectsToRemove = [];
            objects.forEach(obj => {
                if (obj.isBasePhoto) {
                    objectsToRemove.push(obj);
                }
            });
            // 批量移除物件
            objectsToRemove.forEach(obj => {
                try {
                    canvas.remove(obj);
                } catch (e) {
                    // 移除物件時發生錯誤（靜默處理）
                }
            });
            
            // 清除背景圖片
            try {
                canvas.setBackgroundImage(null, () => {});
            } catch (e) {
                // 清除背景圖片時發生錯誤（靜默處理）
            }
            
            // 確保畫布已更新，清除所有選中狀態
            canvas.discardActiveObject();
            canvas.renderAll();

            // 載入新照片
            fabric.Image.fromURL(imageUrl, (img) => {
                // 再次檢查並清除任何殘留的照片物件
                const remainingObjects = canvas.getObjects();
                remainingObjects.forEach(obj => {
                    if (obj.isBasePhoto && obj !== img) {
                        try {
                            canvas.remove(obj);
                        } catch (e) {
                            // 清除殘留照片物件時發生錯誤（靜默處理）
                        }
                    }
                });
                const targetWidth = canvas.width;
                const targetHeight = canvas.height;
                const scaleX = targetWidth / img.width;
                const scaleY = targetHeight / img.height;
                const scale = Math.max(scaleX, scaleY);
                const scaledWidth = img.width * scale;
                const scaledHeight = img.height * scale;
                const left = (targetWidth - scaledWidth) / 2;
                const top = (targetHeight - scaledHeight) / 2;

                // 保存照片原始屬性
                photoOriginalProps = {
                    left: left,
                    top: top,
                    scaleX: scale,
                    scaleY: scale,
                    angle: 0,
                    originX: 'left',
                    originY: 'top'
                };

                img.set({
                    left,
                    top,
                    originX: 'left',
                    originY: 'top',
                    scaleX: scale,
                    scaleY: scale,
                    selectable: false, // 默認不可選中，需要點擊照片調整按鈕才能操作
                    evented: false, // 默認不響應事件
                    hasControls: false, // 默認不顯示控制點
                    hasBorders: false, // 默認不顯示邊框
                    lockRotation: true, // 默認鎖定旋轉
                    lockScalingX: true, // 默認鎖定水平縮放
                    lockScalingY: true, // 默認鎖定垂直縮放
                    lockMovementX: true, // 默認鎖定水平移動
                    lockMovementY: true, // 默認鎖定垂直移動
                    cornerSize: 12,
                    transparentCorners: false,
                    borderColor: '#FF8C42',
                    cornerColor: '#FF8C42',
                    isBasePhoto: true,
                    globalCompositeOperation: 'source-over'
                });

                // 確保 mainPhotoObj 已清除
                if (mainPhotoObj && mainPhotoObj !== img) {
                    try {
                        canvas.remove(mainPhotoObj);
                    } catch (e) {
                        // 清除舊 mainPhotoObj 時發生錯誤（靜默處理）
                    }
                }
                
                // 添加新照片
                canvas.add(img);
                canvas.sendToBack(img);
                
                // 再次檢查並移除任何其他 isBasePhoto 物件（除了剛添加的）
                const allObjects = canvas.getObjects();
                allObjects.forEach(obj => {
                    if (obj.isBasePhoto && obj !== img) {
                        try {
                            canvas.remove(obj);
                        } catch (e) {
                            // 清除重複照片物件時發生錯誤（靜默處理）
                        }
                    }
                });
                
                // 確保照片默認不可選中，需要點擊照片調整按鈕才能操作
                // 再次確認照片設置為不可選中狀態（防止被意外選中）
                img.set({
                    selectable: false,
                    evented: false,
                    hasControls: false,
                    hasBorders: false,
                    lockRotation: true,
                    lockScalingX: true,
                    lockScalingY: true,
                    lockMovementX: true,
                    lockMovementY: true
                });
                
                // 不自動選中，需要點擊照片調整按鈕才能操作
                canvas.discardActiveObject();
                mainPhotoObj = img;
                canvas.renderAll();
                saveHistory();
                enableAllFeatures();
                // 重置照片調整狀態（新照片需要重新調整）
                hasPhotoAdjusted = false;
                updateConfirmButtonState();

                // 如果標記為需要顯示貼圖選擇視窗，則顯示
                if (shouldShowStickerModal) {
                    shouldShowStickerModal = false;
                    // 先關閉功能說明圖（如果有的話）
                    const functionGuideModal = document.getElementById('functionGuideModal');
                    if (functionGuideModal) {
                        functionGuideModal.classList.remove('active');
                    }
                    // 關閉 React 功能說明圖
                    const modalRoot = document.getElementById('modal-root');
                    if (modalRoot) {
                        const functionGuideOverlay = modalRoot.querySelector('.function-guide-modal-overlay');
                        if (functionGuideOverlay) {
                            functionGuideOverlay.style.display = 'none';
                        }
                        const backgroundLayer = document.querySelector('.function-guide-background-layer');
                        if (backgroundLayer) {
                            backgroundLayer.style.display = 'none';
                        }
                    }
                    setTimeout(() => {
                        showStickerSelectionModal();
                    }, 500);
                }

            }, { crossOrigin: 'anonymous' });
        }

        // 啟用所有功能（若有被禁用）
        function enableAllFeatures() {
            const microphoneBtn = document.getElementById('microphoneBtn');
            const imageEditBtn = document.getElementById('imageEditBtn');
            const brushBtn = document.getElementById('brushBtn');
            
            if (microphoneBtn) {
                microphoneBtn.disabled = false;
                microphoneBtn.classList.remove('disabled');
            }
            if (imageEditBtn) {
                imageEditBtn.disabled = false;
                imageEditBtn.classList.remove('disabled');
            }
            if (brushBtn) {
                brushBtn.disabled = false;
                brushBtn.classList.remove('disabled');
            }
        }


        // 檢查畫布上是否有繪畫內容
        function checkDrawingStatus() {
            if (!canvas) {
                hasDrawing = false;
                return;
            }
            // 檢查畫布上是否有路徑對象（繪畫內容）
            const objects = canvas.getObjects();
            hasDrawing = objects.some(obj => obj.type === 'path' || obj.type === 'group');
        }

        // 檢查並更新確認按鈕狀態
        function updateConfirmButtonState() {
            const confirmBtn = document.getElementById('editorConfirmBtn');
            if (!confirmBtn) return;

            // 檢查三個條件：錄音、照片調整、繪畫
            const hasAudio = audioBlob !== null;
            const hasPhoto = hasPhotoAdjusted;
            // 重新檢查繪畫狀態
            checkDrawingStatus();

            // 只有三個條件都滿足時才啟用按鈕
            const allConditionsMet = hasAudio && hasPhoto && hasDrawing;
            confirmBtn.disabled = !allConditionsMet;
        }

        // 編輯頁面確認按鈕（勾勾）- 上傳照片到主頁
        function confirmEditorTemplate() {
            if (!canvas) {
                alert('畫布未初始化，無法上傳');
                return;
            }
            
            // 再次檢查條件（三個步驟都必須完成）
            checkDrawingStatus();
            if (!audioBlob || !hasPhotoAdjusted || !hasDrawing) {
                let missingItems = [];
                if (!audioBlob) missingItems.push('錄音');
                if (!hasPhotoAdjusted) missingItems.push('照片調整');
                if (!hasDrawing) missingItems.push('繪畫');
                alert('請完成以下項目：\n' + missingItems.join('、\n'));
                return;
            }
            
            // 三個條件都滿足，直接開始上傳流程
            // 取消選中任何物件
            canvas.discardActiveObject();
            canvas.renderAll();
            
            // 將畫布導出為圖片（包含背景和所有物件）
            let imageData = null;
            try {
                imageData = canvas.toDataURL({
                    format: 'png',
                    quality: 1,
                    multiplier: 1
                });
                
                // 基本驗證導出的數據
                if (!imageData || imageData === 'data:,') {
                    throw new Error('畫布導出失敗，數據為空');
                }
            } catch (error) {
                console.error('導出畫布時發生錯誤:', error);
                if (error.name === 'SecurityError' || error.message.includes('tainted')) {
                    alert('無法導出畫布：畫布包含跨域圖片。\n\n請確保：\n1. 使用本地服務器運行（不要直接打開 HTML 文件）\n2. 所有圖片文件都在同一個域下\n3. 圖片服務器允許跨域訪問\n\n錯誤: ' + error.message);
                } else {
                    alert('導出畫布時發生錯誤: ' + error.message);
                }
                return;
            }
            
            // 將錄音轉換為 base64（三個條件已滿足，一定有錄音）
            if (audioBlob) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const audioData = reader.result;
                    // 直接保存，不進行額外驗證
                    savePhotoAndAudio(imageData, audioData);
                };
                reader.onerror = () => {
                    console.error('讀取錄音文件時發生錯誤');
                    // 即使讀取錄音失敗，也嘗試保存照片
                    savePhotoAndAudio(imageData, null);
                };
                reader.readAsDataURL(audioBlob);
            } else {
                // 理論上不會到這裡（因為已經檢查了 audioBlob），但為了保險起見
                savePhotoAndAudio(imageData, null);
            }
        }
        
        // 保存照片和錄音到 localStorage
        function savePhotoAndAudio(imageData, audioData) {
            try {
                // 基本驗證照片數據
                if (!imageData || imageData === 'data:,') {
                    console.error('照片數據無效');
                    alert('照片數據無效，無法保存');
                    return;
                }
                
                console.log('開始保存照片和錄音...');
                console.log('- 照片數據長度:', imageData ? imageData.length : 0);
                console.log('- 錄音數據:', audioData ? '存在（長度: ' + audioData.length + '）' : '不存在');
                
                // 檢查 localStorage 是否可用
                try {
                    const test = '__localStorage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                } catch (e) {
                    console.error('localStorage 不可用:', e);
                    alert('⚠️ 瀏覽器阻止了本地存儲！\n\n請按照以下步驟解決：\n\n1. 點擊瀏覽器地址欄左側的鎖定圖標\n2. 選擇「網站設定」或「Cookie 和網站權限」\n3. 允許「Cookie 和網站數據」\n4. 關閉「追蹤預防」功能\n5. 刷新頁面後重新嘗試\n\n或使用其他瀏覽器（如 Chrome）試試。');
                    return;
                }
                
                // 獲取現有的照片列表
                let savedPhotos = [];
                try {
                    const savedData = localStorage.getItem('savedPhotos');
                    if (savedData) {
                        savedPhotos = JSON.parse(savedData);
                        console.log('- 現有照片數量:', savedPhotos.length);
                    }
                } catch (e) {
                    console.warn('無法讀取 localStorage，使用空陣列:', e);
                    savedPhotos = [];
                }
                
                // 添加新照片到陣列前面（最新的在前）
                const newPhoto = {
                    id: Date.now(),
                    image: imageData,
                    audio: audioData || null, // 錄音數據（base64 格式），可能為 null
                    timestamp: new Date().toISOString()
                };
                savedPhotos.unshift(newPhoto);
                console.log('- 新照片已添加到列表，總數:', savedPhotos.length);
                
                // 只保留最新的6張照片（對應6個卡片）
                if (savedPhotos.length > 6) {
                    savedPhotos = savedPhotos.slice(0, 6);
                    console.log('- 已限制為最新6張照片');
                }
                
                // 保存到 localStorage（添加更詳細的錯誤處理）
                try {
                    const dataToSave = JSON.stringify(savedPhotos);
                    const dataSize = new Blob([dataToSave]).size;
                    console.log('- 準備保存的數據大小:', (dataSize / 1024 / 1024).toFixed(2), 'MB');
                    
                    // 檢查數據大小（localStorage 通常限制為 5-10MB）
                    if (dataSize > 5 * 1024 * 1024) {
                        console.warn('數據大小超過 5MB，可能無法保存');
                    }
                    
                    localStorage.setItem('savedPhotos', dataToSave);
                    
                    // 驗證保存是否成功
                    const verifyData = localStorage.getItem('savedPhotos');
                    if (!verifyData) {
                        throw new Error('保存後驗證失敗，數據可能未正確保存');
                    }
                    
                    // 驗證保存的數據是否包含新照片
                    try {
                        const verifyPhotos = JSON.parse(verifyData);
                        const foundNewPhoto = verifyPhotos.find(p => p.id === newPhoto.id);
                        if (!foundNewPhoto) {
                            console.warn('保存後驗證：新照片未在保存的數據中找到，但繼續執行');
                        } else {
                            console.log('✅ 保存驗證成功，新照片已確認保存');
                        }
                    } catch (verifyError) {
                        console.warn('保存驗證時發生錯誤，但繼續執行:', verifyError);
                    }
                    
                    console.log('✅ 已成功保存到 localStorage');
                    console.log('✅ 準備跳轉到照片區...');
                    
                    // 重置狀態變量，允許再次上傳（雖然會跳轉，但為了保險起見）
                    audioBlob = null;
                    hasPhotoAdjusted = false;
                    hasDrawing = false;
                    
                    // 立即跳轉到照片區，不進行額外驗證
                    window.location.href = 'photos.html?upload=success';
                    
                } catch (e) {
                    console.error('無法保存到 localStorage:', e);
                    
                    // 檢查是否是配額超出錯誤
                    if (e.name === 'QuotaExceededError' || e.code === 22 || e.code === 1014) {
                        alert('⚠️ 存儲空間不足！\n\n請刪除一些舊照片後再試，或使用其他瀏覽器。\n\n錯誤: ' + e.message);
                    } else if (e.name === 'SecurityError' || e.code === 18) {
                        alert('⚠️ 瀏覽器安全設定阻止了存儲！\n\n請檢查瀏覽器設定：\n1. 允許 Cookie 和網站數據\n2. 關閉追蹤預防功能\n3. 確保使用本地服務器運行（不要直接打開 HTML 文件）\n\n錯誤: ' + e.message);
                    } else {
                        alert('無法保存照片，請檢查瀏覽器的隱私設定，允許網站使用本地存儲。\n\n錯誤: ' + e.message + '\n\n錯誤類型: ' + e.name);
                    }
                    return;
                }
            } catch (error) {
                console.error('保存照片時發生錯誤:', error);
                alert('保存照片時發生錯誤，請重試。\n\n錯誤: ' + error.message + '\n\n錯誤類型: ' + error.name);
            }
        }
        

        // 錄音功能
        async function toggleRecording() {
            const btn = document.getElementById('microphoneBtn');
            const timeDisplay = document.getElementById('recordingTime');
            const recordingModal = document.getElementById('recordingModal');
            const recordingTimeDisplay = document.getElementById('recordingTimeDisplay');
            const recordingConfirmModal = document.getElementById('recordingConfirmModal');
            const editMenu = document.getElementById('editMenu');
            const imageEditBtn = document.getElementById('imageEditBtn');
            const brushMenu = document.getElementById('brushMenu');
            const brushBtn = document.getElementById('brushBtn');
            
            // 關閉照片編輯選單和畫筆選單，並取消照片選中
            deselectPhoto();
            if (editMenu.classList.contains('active')) {
                editMenu.classList.remove('active');
            }
            if (brushMenu.classList.contains('active')) {
                brushMenu.classList.remove('active');
                brushBtn.classList.remove('active');
                if (canvas) {
                    canvas.isDrawingMode = false;
                }
            }
            
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                // 開始錄音
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        // 如果之前有音訊 URL，先釋放它
                        if (audioUrl) {
                            URL.revokeObjectURL(audioUrl);
                        }
                        audioUrl = URL.createObjectURL(audioBlob);

                        // 設定預覽播放器（僅在確認框中出現）
                        const previewAudio = document.getElementById('recordingPreview');
                        previewAudio.src = audioUrl;
                        previewAudio.load();

                        // 確保音訊載入完成後可以播放
                        previewAudio.addEventListener('canplay', () => {
                            // 錄音完成，可以播放預覽
                        }, { once: true });
                        
                        stream.getTracks().forEach(track => track.stop());
                        recordingConfirmModal.classList.add('active');
                        // 錄音完成後檢查按鈕狀態（但還需要確認錄音）
                    };

                    mediaRecorder.start();
                    btn.classList.add('recording', 'active');
                    timeDisplay.style.display = 'block';
                    recordingModal.classList.add('active');
                    recordingTime = 0;
                    updateRecordingTime();
                    recordingTimer = setInterval(() => {
                        recordingTime++;
                        updateRecordingTime();
                    }, 1000);
                } catch (error) {
                    console.error('無法開啟麥克風:', error);
                    alert('無法開啟麥克風，請檢查權限設定');
                }
            } else {
                // 停止錄音
                stopRecording();
            }
        }

        function stopRecording() {
            const btn = document.getElementById('microphoneBtn');
            const timeDisplay = document.getElementById('recordingTime');
            const recordingModal = document.getElementById('recordingModal');
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            btn.classList.remove('recording', 'active');
            timeDisplay.style.display = 'none';
            recordingModal.classList.remove('active');
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        function updateRecordingTime() {
            const mins = Math.floor(recordingTime / 60);
            const secs = recordingTime % 60;
            const timeText = `${mins}:${secs.toString().padStart(2, '0')}`;
            document.getElementById('recordingTime').textContent = timeText;
            document.getElementById('recordingTimeDisplay').textContent = timeText;
        }

        function resetRecordedAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            const audioEl = document.getElementById('audioElement');
            const previewAudio = document.getElementById('recordingPreview');
            const progressFill = document.getElementById('progressFill');
            const currentTimeSpan = document.getElementById('currentTime');
            const totalTimeSpan = document.getElementById('totalTime');
            if (audioUrl) {
                URL.revokeObjectURL(audioUrl);
            }
            audioUrl = null;
            audioBlob = null;
            audioPlayer.style.display = 'none';
            audioEl.pause();
            audioEl.src = '';
            previewAudio.pause();
            previewAudio.src = '';
            progressFill.style.width = '0%';
            currentTimeSpan.textContent = '0:00';
            totalTimeSpan.textContent = '0:00';
        }

        function confirmRecording() {
            if (!audioUrl) return;
            const confirmModal = document.getElementById('recordingConfirmModal');
            const audioPlayer = document.getElementById('audioPlayer');
            document.getElementById('recordingPreview').pause();
            audioPlayer.style.display = 'block';
            setupAudioPlayer();
            confirmModal.classList.remove('active');
            // 錄音確認後檢查按鈕狀態
            updateConfirmButtonState();
        }

        function redoRecording() {
            resetRecordedAudio();
            document.getElementById('recordingConfirmModal').classList.remove('active');
            // 重新打開錄音畫面
            const recordingModal = document.getElementById('recordingModal');
            const timeDisplay = document.getElementById('recordingTime');
            const recordingTimeDisplay = document.getElementById('recordingTimeDisplay');
            const btn = document.getElementById('microphoneBtn');
            
            // 重新開始錄音
            toggleRecording();
        }

        // 取消照片選中狀態並移除調整框
        function deselectPhoto() {
            if (!canvas) return;
            
            const imageEditBtn = document.getElementById('imageEditBtn');
            if (imageEditBtn && imageEditBtn.classList.contains('active')) {
                // 找到主照片
                let targetPhoto = mainPhotoObj;
                if (!targetPhoto) {
                    const objects = canvas.getObjects();
                    targetPhoto = objects.find(obj => obj.isBasePhoto);
                }
                
                if (targetPhoto) {
                    // 恢復照片原始位置和屬性
                    if (photoOriginalProps) {
                        targetPhoto.set({
                            left: photoOriginalProps.left,
                            top: photoOriginalProps.top,
                            scaleX: photoOriginalProps.scaleX,
                            scaleY: photoOriginalProps.scaleY,
                            angle: photoOriginalProps.angle,
                            originX: photoOriginalProps.originX,
                            originY: photoOriginalProps.originY
                        });
                    }
                    
                    // 禁用照片編輯模式：鎖定所有操作
                    targetPhoto.set({
                        selectable: false,
                        evented: false,
                        hasControls: false,
                        hasBorders: false,
                        lockRotation: true,
                        lockScalingX: true,
                        lockScalingY: true,
                        lockMovementX: true,
                        lockMovementY: true
                    });
                    // 取消選中
                    canvas.discardActiveObject();
                    canvas.renderAll();
                }
                
                // 移除按鈕的 active 狀態
                imageEditBtn.classList.remove('active');
            }
        }

        // 照片編輯功能
        function toggleEditMenu() {
            const menu = document.getElementById('editMenu');
            const btn = document.getElementById('imageEditBtn');
            const brushMenu = document.getElementById('brushMenu');
            const brushBtn = document.getElementById('brushBtn');
            
            // 關閉畫筆選單
            if (brushMenu.classList.contains('active')) {
                brushMenu.classList.remove('active');
                brushBtn.classList.remove('active');
                if (canvas) {
                    canvas.isDrawingMode = false;
                }
            }
            
            // 不顯示選單，只切換按鈕狀態
            const isActive = btn.classList.contains('active');
            btn.classList.toggle('active');
            // 確保選單不顯示
            menu.classList.remove('active');
            
            // 啟用或禁用照片的選中、移動和旋轉功能
            if (canvas) {
                // 關閉畫筆模式
                canvas.isDrawingMode = false;
                
                // 找到主照片
                let targetPhoto = mainPhotoObj;
                if (!targetPhoto) {
                    const objects = canvas.getObjects();
                    targetPhoto = objects.find(obj => obj.isBasePhoto);
                }
                
                if (targetPhoto) {
                    if (!isActive) {
                        // 啟用照片編輯模式：允許選中、移動、旋轉、縮放
                        targetPhoto.set({
                            selectable: true,
                            evented: true,
                            hasControls: true,
                            hasBorders: true,
                            lockRotation: false,
                            lockScalingX: false,
                            lockScalingY: false,
                            lockMovementX: false,
                            lockMovementY: false,
                            cornerSize: 12,
                            transparentCorners: false,
                            borderColor: '#FF8C42',
                            cornerColor: '#FF8C42'
                        });
                        // 自動選中照片
                        canvas.setActiveObject(targetPhoto);
                        canvas.renderAll();
                    } else {
                        // 恢復照片原始位置和屬性
                        if (photoOriginalProps) {
                            targetPhoto.set({
                                left: photoOriginalProps.left,
                                top: photoOriginalProps.top,
                                scaleX: photoOriginalProps.scaleX,
                                scaleY: photoOriginalProps.scaleY,
                                angle: photoOriginalProps.angle,
                                originX: photoOriginalProps.originX,
                                originY: photoOriginalProps.originY
                            });
                        }
                        
                        // 禁用照片編輯模式：鎖定所有操作
                        targetPhoto.set({
                            selectable: false,
                            evented: false,
                            hasControls: false,
                            hasBorders: false,
                            lockRotation: true,
                            lockScalingX: true,
                            lockScalingY: true,
                            lockMovementX: true,
                            lockMovementY: true
                        });
                        canvas.discardActiveObject();
                        canvas.renderAll();
                    }
                }
            }
        }

        function rotateImage(angle) {
            if (canvas && currentImage) {
                // 調整主照片
                const basePhoto = canvas.getObjects().find(obj => obj.isBasePhoto);
                if (basePhoto) {
                    basePhoto.rotate((basePhoto.angle || 0) + angle);
                    canvas.renderAll();
                    saveHistory();
                }
            }
        }

        // 垂直翻轉（上下翻轉）：以水平中線為軸，等同 scaleY(-1)
        function flipVertical() {
            if (!canvas) {
                console.error('Canvas not initialized');
                return;
            }
            
            if (!currentImage && !mainPhotoObj) {
                alert('請先載入照片');
                return;
            }
            
            // 調整主照片（優先使用 mainPhotoObj，否則尋找 isBasePhoto）
            let targetPhoto = mainPhotoObj;
            if (!targetPhoto) {
                const objects = canvas.getObjects();
                targetPhoto = objects.find(obj => obj.isBasePhoto);
                console.log('Found basePhoto:', targetPhoto);
            }
            
            if (targetPhoto) {
                // 垂直翻轉（上下顛倒）：使用 scaleY(-1) 來實現上下顛倒
                const currentScaleY = targetPhoto.scaleY || 1;
                const newScaleY = currentScaleY > 0 ? -Math.abs(currentScaleY) : Math.abs(currentScaleY);
                targetPhoto.set('scaleY', newScaleY);
                // 確保 scaleX 保持不變
                const currentScaleX = targetPhoto.scaleX || 1;
                targetPhoto.set('scaleX', currentScaleX);
                canvas.renderAll();
                saveHistory();
            } else {
                // 如果找不到主照片物件，嘗試調整背景圖片
                const bgImage = canvas.backgroundImage;
                if (bgImage) {
                    // 垂直翻轉（上下顛倒）：使用 scaleY(-1) 來實現上下顛倒
                    const currentScaleY = bgImage.scaleY || 1;
                    const newScaleY = currentScaleY > 0 ? -Math.abs(currentScaleY) : Math.abs(currentScaleY);
                    bgImage.set('scaleY', newScaleY);
                    // 確保 scaleX 保持不變
                    const currentScaleX = bgImage.scaleX || 1;
                    bgImage.set('scaleX', currentScaleX);
                    canvas.renderAll();
                    saveHistory();
                    } else {
                    console.error('No photo object found to flip');
                    alert('找不到照片物件，請重新載入照片');
                }
            }
        }
        
        // 水平翻轉（左右翻轉）：以垂直中線為軸，等同 scaleX(-1)
        function flipHorizontal() {
            if (!canvas) {
                console.error('Canvas not initialized');
                return;
            }
            
            if (!currentImage && !mainPhotoObj) {
                alert('請先載入照片');
                return;
            }
            
            // 調整主照片（優先使用 mainPhotoObj，否則尋找 isBasePhoto）
            let targetPhoto = mainPhotoObj;
            if (!targetPhoto) {
                const objects = canvas.getObjects();
                targetPhoto = objects.find(obj => obj.isBasePhoto);
            }
            
            if (targetPhoto) {
                // 水平翻轉（左右翻轉）：使用 scaleX(-1) 來實現左右翻轉
                const currentScaleX = targetPhoto.scaleX || 1;
                const newScaleX = currentScaleX > 0 ? -Math.abs(currentScaleX) : Math.abs(currentScaleX);
                targetPhoto.set('scaleX', newScaleX);
                // 確保 scaleY 保持不變
                const currentScaleY = targetPhoto.scaleY || 1;
                targetPhoto.set('scaleY', currentScaleY);
                canvas.renderAll();
                saveHistory();
            } else {
                // 如果找不到主照片物件，嘗試調整背景圖片
                const bgImage = canvas.backgroundImage;
                if (bgImage) {
                    // 水平翻轉（左右翻轉）：使用 scaleX(-1) 來實現左右翻轉
                    const currentScaleX = bgImage.scaleX || 1;
                    const newScaleX = currentScaleX > 0 ? -Math.abs(currentScaleX) : Math.abs(currentScaleX);
                    bgImage.set('scaleX', newScaleX);
                    // 確保 scaleY 保持不變
                    const currentScaleY = bgImage.scaleY || 1;
                    bgImage.set('scaleY', currentScaleY);
                    canvas.renderAll();
                    saveHistory();
                } else {
                    console.error('No photo object found to flip');
                    alert('找不到照片物件，請重新載入照片');
                }
            }
        }
        
        // 保留舊的 flipImage 函數以向後兼容，但內部調用新的獨立函數
        function flipImage(direction) {
            if (direction === 'vertical') {
                flipVertical();
            } else if (direction === 'horizontal') {
                flipHorizontal();
            } else {
                console.error('Invalid direction:', direction);
            }
        }

        // 畫筆模式功能
        function toggleBrush() {
            if (canvas) {
                isDrawing = !canvas.isDrawingMode;
                canvas.isDrawingMode = isDrawing;
                const btn = document.getElementById('brushBtn');
                const menu = document.getElementById('brushMenu');
                const editMenu = document.getElementById('editMenu');
                const imageEditBtn = document.getElementById('imageEditBtn');
                
                // 關閉照片編輯選單並取消照片選中
                deselectPhoto();
                if (editMenu.classList.contains('active')) {
                    editMenu.classList.remove('active');
                }
                
                    if (isDrawing) {
                    btn.classList.add('active');
                    menu.classList.add('active');
                    // 根據當前工具設定畫筆模式
                    if (currentTool === 'pen') {
                        canvas.freeDrawingBrush.color = brushColor;
                        canvas.freeDrawingBrush.width = brushWidth;
                        // 畫筆模式優化
                        canvas.freeDrawingBrush.strokeLineCap = 'round';
                        canvas.freeDrawingBrush.strokeLineJoin = 'round';
                        canvas.freeDrawingBrush.globalCompositeOperation = 'source-over';
                    } else if (currentTool === 'eraser') {
                        canvas.freeDrawingBrush.color = '#ffffff';
                        canvas.freeDrawingBrush.width = brushWidth;
                        canvas.freeDrawingBrush.strokeLineCap = 'round';
                        canvas.freeDrawingBrush.strokeLineJoin = 'round';
                        canvas.freeDrawingBrush.globalCompositeOperation = 'source-over';
                    }
                    // 保存歷史狀態
                    saveHistory();
                } else {
                    btn.classList.remove('active');
                    menu.classList.remove('active');
                    // 關閉繪畫模式時，確保沒有選中對象
                    canvas.discardActiveObject();
                    canvas.renderAll();
                }
            }
        }

        // 切換到畫筆模式
        function switchToPen() {
            currentTool = 'pen';
            if (canvas && canvas.isDrawingMode) {
                canvas.freeDrawingBrush.color = brushColor;
                // 畫筆模式：使用更平滑的筆觸
                canvas.freeDrawingBrush.width = brushWidth;
                canvas.freeDrawingBrush.strokeLineCap = 'round';
                canvas.freeDrawingBrush.strokeLineJoin = 'round';
                canvas.freeDrawingBrush.globalCompositeOperation = 'source-over';
            }
            const eraserBtn = document.getElementById('eraserToolBtn');
            if (eraserBtn) {
                // 切換回橡皮擦圖標
                const img = eraserBtn.querySelector('img');
                if (img) {
                    img.src = 'POT/橡皮擦.png';
                    img.alt = '橡皮擦';
                }
                eraserBtn.title = '橡皮擦';
                eraserBtn.classList.remove('active');
            }
        }

        // 切換到橡皮擦（點擊一次切換到橡皮擦，再點擊一次切換回繪畫）
        function switchToEraser() {
            const brushBtn = document.getElementById('brushBtn');
            // 如果畫筆按鈕不是 active，無法使用工具
            if (!brushBtn || !brushBtn.classList.contains('active')) {
                return;
            }
            
            // 如果當前是橡皮擦模式，切換回繪畫模式
            if (currentTool === 'eraser') {
                switchToPen();
            } else {
                // 切換到橡皮擦模式
                currentTool = 'eraser';
                if (canvas && canvas.isDrawingMode) {
                    // 使用 destination-out 來擦除
                    canvas.freeDrawingBrush.color = '#ffffff';
                    canvas.freeDrawingBrush.width = brushWidth;
                    canvas.freeDrawingBrush.strokeLineCap = 'round';
                    canvas.freeDrawingBrush.strokeLineJoin = 'round';
                    canvas.freeDrawingBrush.globalCompositeOperation = 'destination-out';
                }
                const eraserBtn = document.getElementById('eraserToolBtn');
                if (eraserBtn) {
                    // 切換到畫筆圖標
                    const img = eraserBtn.querySelector('img');
                    if (img) {
                        img.src = 'POT/橡皮擦中的畫筆.png';
                        img.alt = '畫筆';
                    }
                    eraserBtn.title = '畫筆';
                    eraserBtn.classList.add('active');
                }
            }
        }

        // 保存歷史狀態
        function saveHistory() {
            if (canvas) {
                const json = JSON.stringify(canvas.toJSON());
                historyState.push(json);
                // 限制歷史記錄數量
                if (historyState.length > 20) {
                    historyState.shift();
                }
            }
        }

        // 復原
        function undoLastAction() {
            if (canvas && historyState.length > 0) {
                historyState.pop(); // 移除當前狀態
                if (historyState.length > 0) {
                    // 恢復上一個狀態
                    canvas.loadFromJSON(historyState[historyState.length - 1], () => {
                        canvas.discardActiveObject();
                        canvas.renderAll();
                        // 檢查是否還有繪畫內容
                        checkDrawingStatus();
                        updateConfirmButtonState();
                    });
                } else {
                    // 如果沒有歷史記錄，清空畫布
                    canvas.clear();
                    hasDrawing = false;
                    updateConfirmButtonState();
                    if (currentImage) {
                        // 重新載入背景圖片（滿版顯示）
                        fabric.Image.fromURL(currentImage, (img) => {
                            // 固定目標尺寸（使用畫布尺寸），確保所有照片顯示大小一致
                            const targetWidth = canvas.width;
                            const targetHeight = canvas.height;
                            
                            // 計算固定縮放比例，讓照片填滿固定尺寸
                            const scaleX = targetWidth / img.width;
                            const scaleY = targetHeight / img.height;
                            // 使用較大的縮放比例，讓照片完全填滿固定尺寸（cover 模式）
                            const scale = Math.max(scaleX, scaleY);
                            
                            // 計算縮放後的尺寸
                            const scaledWidth = img.width * scale;
                            const scaledHeight = img.height * scale;
                            
                            // 計算居中位置
                            const left = (targetWidth - scaledWidth) / 2;
                            const top = (targetHeight - scaledHeight) / 2;
                            
                            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                                scaleX: scale,
                                scaleY: scale,
                                originX: 'left',
                                originY: 'top',
                                left: left,
                                top: top
                            });
                        }, (error) => {
                            console.error('重新載入照片時發生錯誤:', error);
                        });
                    }
                    canvas.discardActiveObject();
                    canvas.renderAll();
                }
            }
        }

        // 監聽畫布變化，自動保存歷史（已在初始化時設置）

        // 音訊播放器
        let audioPlayerIsPlaying = false;
        let audioPlayerSetup = false;

        function setupAudioPlayer() {
            if (!audioUrl) return;

            const audio = document.getElementById('audioElement');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const progressFill = document.getElementById('progressFill');
            const currentTimeSpan = document.getElementById('currentTime');
            const totalTimeSpan = document.getElementById('totalTime');
            const progressBar = document.getElementById('progressBar');

            // 如果已經設置過，先移除舊的事件監聽器
            if (audioPlayerSetup) {
                audio.removeEventListener('loadedmetadata', handleLoadedMetadata);
                audio.removeEventListener('timeupdate', handleTimeUpdate);
                audio.removeEventListener('ended', handleEnded);
                playPauseBtn.removeEventListener('click', handlePlayPause);
                progressBar.removeEventListener('click', handleProgressClick);
            }

            audio.src = audioUrl;
            audioPlayerIsPlaying = false;
            audioPlayerSetup = true;

            // 載入元數據
            function handleLoadedMetadata() {
                totalTimeSpan.textContent = formatTime(audio.duration);
            }

            // 更新時間
            function handleTimeUpdate() {
                if (audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressFill.style.width = progress + '%';
                    currentTimeSpan.textContent = formatTime(audio.currentTime);
                }
            }

            // 播放結束
            function handleEnded() {
                audioPlayerIsPlaying = false;
                playPauseBtn.textContent = '▶';
                playPauseBtn.classList.remove('playing');
                audio.currentTime = 0;
                progressFill.style.width = '0%';
                currentTimeSpan.textContent = '0:00';
            }

            // 播放/暫停
            function handlePlayPause() {
                if (audioPlayerIsPlaying) {
                    audio.pause();
                    playPauseBtn.textContent = '▶';
                    playPauseBtn.classList.remove('playing');
                } else {
                    audio.play().catch(err => {
                        console.error('播放失敗:', err);
                    });
                    playPauseBtn.textContent = '⏸';
                    playPauseBtn.classList.add('playing');
                }
                audioPlayerIsPlaying = !audioPlayerIsPlaying;
            }

            // 進度條點擊
            function handleProgressClick(e) {
                if (audio.duration) {
                    const rect = progressBar.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const percentage = clickX / rect.width;
                    audio.currentTime = percentage * audio.duration;
                }
            }

            // 添加事件監聽器
            audio.addEventListener('loadedmetadata', handleLoadedMetadata);
            audio.addEventListener('timeupdate', handleTimeUpdate);
            audio.addEventListener('ended', handleEnded);
            playPauseBtn.addEventListener('click', handlePlayPause);
            progressBar.addEventListener('click', handleProgressClick);

            // 確保音訊載入
            audio.load();
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 點擊外部關閉選單（不關閉正在操作的畫筆/編輯選單）
        document.addEventListener('click', (e) => {
            const insideToolBtn = e.target.closest('.tool-btn-container');
            const insideEditMenu = e.target.closest('.edit-menu');
            const insideBrushMenu = e.target.closest('.brush-menu');
            const insideCanvas = e.target.closest('#editorCanvas') || e.target.closest('.canvas-container');
            
            // 如果點擊在背景上（不在選單、按鈕或畫布上），關閉選單
            if (!insideToolBtn && !insideEditMenu && !insideBrushMenu && !insideCanvas) {
                document.getElementById('editMenu').classList.remove('active');
                document.getElementById('brushMenu').classList.remove('active');
                document.getElementById('imageEditBtn').classList.remove('active');
                
                // 畫筆選單消失後，移除畫筆按鈕的 active 狀態並關閉繪畫模式
                const brushBtn = document.getElementById('brushBtn');
                brushBtn.classList.remove('active');
                if (canvas) {
                    canvas.isDrawingMode = false;
                    isDrawing = false;
                }
            }
        });

        // 畫筆功能
        let signatureCanvas = null;
        let signatureCtx = null;
        let isSigning = false;
        let lastX = 0;
        let lastY = 0;

        function setupSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            if (!signatureCanvas) {
                console.warn('signatureCanvas 元素不存在，跳過初始化');
                return;
            }
            signatureCtx = signatureCanvas.getContext('2d');
            
            // 設置 canvas 實際尺寸（根據顯示尺寸）
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCanvas.width = rect.width || 600;
            signatureCanvas.height = rect.height || 300;
            
            // 設置畫筆樣式
            signatureCtx.strokeStyle = '#000000';
            signatureCtx.lineWidth = 3;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';

            // 滑鼠事件
            signatureCanvas.addEventListener('mousedown', startDrawingSignature);
            signatureCanvas.addEventListener('mousemove', drawSignature);
            signatureCanvas.addEventListener('mouseup', stopDrawingSignature);
            signatureCanvas.addEventListener('mouseout', stopDrawingSignature);

            // 觸控事件（設置 passive: false，因為需要 preventDefault）
            signatureCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            signatureCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            signatureCanvas.addEventListener('touchend', stopDrawingSignature, { passive: true });
        }

        function startDrawingSignature(e) {
            isSigning = true;
            const rect = signatureCanvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function drawSignature(e) {
            if (!isSigning) return;
            e.preventDefault();
            
            const rect = signatureCanvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            signatureCtx.beginPath();
            signatureCtx.moveTo(lastX, lastY);
            signatureCtx.lineTo(currentX, currentY);
            signatureCtx.stroke();

            lastX = currentX;
            lastY = currentY;
        }

        function stopDrawingSignature() {
            isSigning = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = signatureCanvas.getBoundingClientRect();
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
            isSigning = true;
        }

        function handleTouchMove(e) {
            if (!isSigning) return;
            e.preventDefault();
            const touch = e.touches[0];
            const rect = signatureCanvas.getBoundingClientRect();
            const currentX = touch.clientX - rect.left;
            const currentY = touch.clientY - rect.top;

            signatureCtx.beginPath();
            signatureCtx.moveTo(lastX, lastY);
            signatureCtx.lineTo(currentX, currentY);
            signatureCtx.stroke();

            lastX = currentX;
            lastY = currentY;
        }

        function clearSignature() {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }

        function openSignatureModal() {
            document.getElementById('signatureModal').classList.add('active');
            clearSignature(); // 打開時清除之前的畫筆內容
            
            // 重新設置 canvas 尺寸（確保響應式）
            setTimeout(() => {
                if (signatureCanvas) {
                    const rect = signatureCanvas.getBoundingClientRect();
                    signatureCanvas.width = rect.width;
                    signatureCanvas.height = rect.height;
                    // 重新設置畫筆樣式
                    signatureCtx.strokeStyle = '#000000';
                    signatureCtx.lineWidth = 3;
                    signatureCtx.lineCap = 'round';
                    signatureCtx.lineJoin = 'round';
                }
            }, 100);
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').classList.remove('active');
        }

        function confirmSignature() {
            if (!canvas || !signatureCanvas || !signatureCtx) {
                console.error('Canvas 未初始化');
                return;
            }

            // 檢查是否有畫筆內容 - 改進檢查邏輯
            const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
            let hasContent = false;
            
            // 檢查是否有非白色像素（畫筆通常是黑色或其他顏色）
            for (let i = 0; i < imageData.data.length; i += 4) {
                const r = imageData.data[i];
                const g = imageData.data[i + 1];
                const b = imageData.data[i + 2];
                const a = imageData.data[i + 3];
                
                // 如果有非白色且不透明的像素，表示有畫筆內容
                if (a > 0 && (r < 250 || g < 250 || b < 250)) {
                    hasContent = true;
                    break;
                }
            }

            if (!hasContent) {
                alert('請先使用畫筆');
                return;
            }

            // 將畫筆內容轉換為圖片
            const signatureDataUrl = signatureCanvas.toDataURL('image/png');

            // 添加到主 canvas
            fabric.Image.fromURL(signatureDataUrl, (img) => {
                if (!img) {
                    console.error('無法載入畫筆圖片');
                    return;
                }

                // 計算畫筆內容尺寸，使其適合畫布大小
                const maxWidth = canvas.width * 0.4; // 最大寬度為畫布的40%
                const maxHeight = canvas.height * 0.3; // 最大高度為畫布的30%
                
                const scaleX = maxWidth / img.width;
                const scaleY = maxHeight / img.height;
                const scale = Math.min(scaleX, scaleY);

                // 計算居中位置
                const scaledWidth = img.width * scale;
                const scaledHeight = img.height * scale;
                const left = (canvas.width - scaledWidth) / 2;
                const top = (canvas.height - scaledHeight) / 2;

                img.set({
                    left: left,
                    top: top,
                    scaleX: scale,
                    scaleY: scale,
                    selectable: true,  // 允許選取
                    evented: true,     // 允許互動
                    hasControls: true, // 顯示控制點
                    hasBorders: true,   // 顯示邊框
                    lockRotation: false, // 允許旋轉
                    lockScalingX: false, // 允許水平縮放
                    lockScalingY: false, // 允許垂直縮放
                    lockMovementX: false, // 允許水平移動
                    lockMovementY: false, // 允許垂直移動
                    cornerSize: 12,    // 控制點大小
                    transparentCorners: false, // 控制點不透明
                    borderColor: '#FEAC3C', // 邊框顏色
                    cornerColor: '#FEAC3C',  // 控制點顏色
                    globalCompositeOperation: 'source-over' // 使用正常混合模式
                });

                // 添加到畫布
                canvas.add(img);
                canvas.setActiveObject(img); // 自動選中畫筆內容
                canvas.renderAll();
                
                // 保存歷史
                if (typeof saveHistory === 'function') {
                    saveHistory();
                }

                // 關閉模態框
                closeSignatureModal();
            }, { crossOrigin: 'anonymous' });
        }

    </script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // 照片詳情 Modal 組件
        function PhotoDetailModal({ isOpen, photo, onClose }) {
            const [audioRef, setAudioRef] = useState(null);

            useEffect(() => {
                // 當模態框關閉時，停止播放錄音
                if (!isOpen && audioRef) {
                    audioRef.pause();
                    audioRef.src = '';
                }
            }, [isOpen, audioRef]);

            if (!isOpen || !photo) return null;

            // 阻止點擊背景關閉
            const handleBackdropClick = (e) => {
                if (e.target === e.currentTarget) {
                    e.stopPropagation();
                }
            };

            return React.createElement('div', {
                className: 'photo-detail-modal-overlay',
                onClick: handleBackdropClick,
                style: {
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 2000,
                    padding: '20px'
                }
            }, 
                React.createElement('div', {
                    className: 'photo-detail-modal-content',
                    onClick: (e) => e.stopPropagation(),
                    style: {
                        position: 'relative',
                        maxWidth: '90%',
                        maxHeight: '90vh',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        gap: '20px'
                    }
                },
                    // 關閉按鈕
                    React.createElement('button', {
                        onClick: onClose,
                        className: 'photo-detail-close-btn',
                        style: {
                            position: 'absolute',
                            top: '-40px',
                            right: '0',
                            background: 'rgba(255, 255, 255, 0.9)',
                            border: 'none',
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            fontSize: '24px',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: '#333',
                            zIndex: 10
                        },
                        onMouseEnter: (e) => {
                            e.target.style.background = 'white';
                        },
                        onMouseLeave: (e) => {
                            e.target.style.background = 'rgba(255, 255, 255, 0.9)';
                        }
                    }, '×'),
                    // 照片容器
                    React.createElement('div', {
                        style: {
                            maxWidth: '100%',
                            maxHeight: '70vh',
                            overflow: 'hidden',
                            background: 'white',
                            borderRadius: '12px',
                            padding: '20px',
                            cursor: 'zoom-in'
                        }
                    },
                        React.createElement('img', {
                            src: photo.image,
                            alt: '照片',
                            style: {
                                maxWidth: '100%',
                                maxHeight: '70vh',
                                objectFit: 'contain',
                                display: 'block',
                                borderRadius: '12px',
                                transition: 'transform 0.3s ease',
                                transformOrigin: 'center center'
                            },
                            onMouseEnter: (e) => {
                                e.target.style.transform = 'scale(1.5)';
                                e.target.style.cursor = 'zoom-out';
                            },
                            onMouseLeave: (e) => {
                                e.target.style.transform = 'scale(1)';
                                e.target.style.cursor = 'zoom-in';
                            }
                        })
                    ),
                    // 錄音播放器（如果有錄音）
                    photo.audio ? React.createElement('div', {
                        style: {
                            width: '100%',
                            maxWidth: '600px',
                            background: 'white',
                            borderRadius: '12px',
                            padding: '20px'
                        }
                    },
                        React.createElement('audio', {
                            ref: (ref) => setAudioRef(ref),
                            src: photo.audio,
                            controls: true,
                            style: {
                                width: '100%',
                                marginTop: '16px'
                            }
                        })
                    ) : null
                )
            );
        }


        // 主應用組件
        function App() {
            const [isPhotoDetailOpen, setIsPhotoDetailOpen] = useState(false);
            const [photoData, setPhotoData] = useState(null);

            const handleClosePhotoDetail = () => {
                setIsPhotoDetailOpen(false);
            };

            return React.createElement(React.Fragment, null,
                React.createElement(PhotoDetailModal, {
                    isOpen: isPhotoDetailOpen,
                    photo: photoData,
                    onClose: handleClosePhotoDetail
                })
            );
        }

        // 渲染應用
        const root = ReactDOM.createRoot(document.getElementById('modal-root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>